FROM node:16

WORKDIR /opt

COPY package.json package-lock.json /opt/

RUN npm ci

COPY . /opt/

ENV NODE_ENV production

ARG VUE_APP_BASE_URL
ARG VUE_APP_IAM_BASE_URL
ARG VUE_APP_API_BASE_URL
ARG VUE_APP_BACKEND_BASE_URL
ARG VUE_APP_VIEWER_BASE_URL
ARG VUE_APP_OIDC_CLIENT_ID
ARG VUE_APP_MAPBOX_TOKEN
ARG VUE_APP_MAX_UPLOAD_SIZE
ARG VUE_APP_URL_BIMDATACONNECT
ARG VUE_APP_URL_DOCUMENTATION
ARG VUE_APP_URL_MARKETPLACE
ARG VUE_APP_ARCHIVE_BASE_URL

ENV VUE_APP_BASE_URL=$VUE_APP_BASE_URL
ENV VUE_APP_IAM_BASE_URL=$VUE_APP_IAM_BASE_URL
ENV VUE_APP_API_BASE_URL=$VUE_APP_API_BASE_URL
ENV VUE_APP_BACKEND_BASE_URL=$VUE_APP_BACKEND_BASE_URL
ENV VUE_APP_VIEWER_BASE_URL=$VUE_APP_VIEWER_BASE_URL
ENV VUE_APP_OIDC_CLIENT_ID=$VUE_APP_OIDC_CLIENT_ID
ENV VUE_APP_MAPBOX_TOKEN=$VUE_APP_MAPBOX_TOKEN
ENV VUE_APP_MAX_UPLOAD_SIZE=$VUE_APP_MAX_UPLOAD_SIZE
ENV VUE_APP_URL_BIMDATACONNECT=$VUE_APP_URL_BIMDATACONNECT
ENV VUE_APP_URL_DOCUMENTATION=$VUE_APP_URL_DOCUMENTATION
ENV VUE_APP_URL_MARKETPLACE=$VUE_APP_URL_MARKETPLACE
ENV VUE_APP_ARCHIVE_BASE_URL=$VUE_APP_ARCHIVE_BASE_URL

RUN npm run build


FROM nginx:stable
RUN rm /etc/nginx/conf.d/default.conf
COPY etc/nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=0 /opt/dist /usr/share/nginx/html
