FROM node:16

WORKDIR /opt

COPY package.json package-lock.json /opt/

RUN npm ci

COPY . /opt/

ENV NODE_ENV production

# Don't forget to update env.sh script too
ARG VUE_APP_BASE_URL=ENV_TOKEN_BASE_URL \
    VUE_APP_IAM_BASE_URL=ENV_TOKEN_IAM_BASE_URL \
    VUE_APP_API_BASE_URL=ENV_TOKEN_API_BASE_URL \
    VUE_APP_BACKEND_BASE_URL=ENV_TOKEN_BACKEND_BASE_URL \
    VUE_APP_OIDC_CLIENT_ID=ENV_TOKEN_OIDC_CLIENT_ID \
    VUE_APP_MAPTILER_TOKEN=ENV_TOKEN_MAPTILER_TOKEN \
    VUE_APP_MAX_UPLOAD_SIZE=ENV_TOKEN_MAX_UPLOAD_SIZE \
    VUE_APP_URL_BIMDATACONNECT=ENV_TOKEN_URL_BIMDATACONNECT \
    VUE_APP_URL_DOCUMENTATION=ENV_TOKEN_URL_DOCUMENTATION \
    VUE_APP_URL_MARKETPLACE=ENV_TOKEN_URL_MARKETPLACE \
    VUE_APP_ARCHIVE_BASE_URL=ENV_TOKEN_ARCHIVE_BASE_URL \
    VUE_APP_URL_OLD_PLATFORM=ENV_TOKEN_URL_OLD_PLATFORM \
    VUE_APP_AUTHORIZED_IDENTITY_PROVIDERS=ENV_TOKEN_AUTHORIZED_IDENTITY_PROVIDERS \
    VUE_APP_SUBSCRIPTION_ENABLED=ENV_TOKEN_SUBSCRIPTION_ENABLED \
    VUE_APP_PADDLE_SANDBOX=ENV_TOKEN_PADDLE_SANDBOX \
    VUE_APP_PADDLE_VENDOR_ID=ENV_TOKEN_PADDLE_VENDOR_ID \
    VUE_APP_FREE_PLAN_STORAGE=ENV_TOKEN_FREE_PLAN_STORAGE \
    VUE_APP_PRO_PLAN_ID=ENV_TOKEN_PRO_PLAN_ID \
    VUE_APP_PRO_PLAN_STORAGE=ENV_TOKEN_PRO_PLAN_STORAGE \
    VUE_APP_DATAPACK_PLAN_ID=ENV_TOKEN_DATAPACK_PLAN_ID \
    VUE_APP_PROJECT_STATUS_LIMIT_NEW=ENV_TOKEN_PROJECT_STATUS_LIMIT_NEW \
    VUE_APP_PROJECT_STATUS_LIMIT_ACTIVE=ENV_TOKEN_PROJECT_STATUS_LIMIT_ACTIVE

RUN npm run build

# Move JS files with templated env variables in another folder to be able to replace tokens at runtime
RUN mv /opt/dist/assets /opt/dist/assets-original

FROM nginx:stable
RUN rm /etc/nginx/conf.d/default.conf
COPY etc/nginx.conf /etc/nginx/conf.d/default.conf
COPY etc/env.sh /docker-entrypoint.d
COPY --from=0 /opt/dist /usr/share/nginx/html
