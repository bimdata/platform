name: Platform-next

on: push

env:
  app: platform_v2

jobs:
  test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: "14"
      - run: npm ci
      #- run: npm run test:e2e
  build-and-push:
    runs-on: self-hosted
    needs: test
    # if: contains('
    #   refs/heads/develop
    #   refs/heads/next
    #   refs/heads/master
    #   refs/heads/main'
    #   , github.ref)
    steps:
      - uses: actions/checkout@v2
      - name: Login to BIMData Docker Registry
        uses: docker/login-action@v1
        with:
          registry: docker-registry.bimdata.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}
      # - id: tag
      #   name: Get docker tag
      #   uses: bimdata/actions/get-docker-tag@v1
      #   with:
      #     branch: ${{ github.ref }}
      - name: Build with ansible
        uses: bimdata/actions/build-image@v1
        with:
          inventory: staging
          app: ${{ env.app }}
          vault-pass: ${{ secrets.ANSIBLE_VAULT_PASSWD }}
      - run: docker images
      - name: Push image to registry
        run: |
          docker tag docker-registry.bimdata.io/bimdata/${{ env.app }}:staging docker-registry.bimdata.io/bimdata/${{ env.app }}:${{ github.sha }}
          docker push docker-registry.bimdata.io/bimdata/${{ env.app }}:staging
          docker push docker-registry.bimdata.io/bimdata/${{ env.app }}:${{ github.sha }}

  deploy:
    runs-on: self-hosted
    needs: build-and-push
    steps:
      - name: Login to BIMData Docker Registry
        uses: docker/login-action@v1
        with:
          registry: docker-registry.bimdata.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}
      # - id: tag
      #   name: Get docker tag
      #   uses: bimdata/actions/get-docker-tag@v1
      #   with:
      #     branch: ${{ github.ref }}
      - name: Deploy on staging
        uses: bimdata/actions/deployment@v1
        with:
          inventory: staging
          app: ${{ env.app }}
          vault-pass: ${{ secrets.ANSIBLE_VAULT_PASSWD }}
